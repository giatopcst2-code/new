<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Stats</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const SpotifyStats = () => {
          const [accessToken, setAccessToken] = useState('');
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [timeRange, setTimeRange] = useState('medium_term');
          const [stats, setStats] = useState(null);
          const [loading, setLoading] = useState(false);

          const CLIENT_ID = 'e42a311c419b4fc3a35f135754ed41dd';
          const REDIRECT_URI = 'https://giatopcst2-code.github.io/new/';
          const SCOPES = ['user-top-read', 'user-read-recently-played'];

          useEffect(() => {
            const hash = window.location.hash;
            if (hash) {
              const token = new URLSearchParams(hash.substring(1)).get('access_token');
              if (token) {
                setAccessToken(token);
                setIsAuthenticated(true);
                window.history.replaceState({}, document.title, window.location.pathname);
              }
            }
          }, []);

          useEffect(() => {
            if (isAuthenticated && accessToken) {
              fetchSpotifyData();
            }
          }, [isAuthenticated, accessToken, timeRange]);

          const handleLogin = () => {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES.join(' '))}&response_type=token`;
            window.location.href = authUrl;
          };

          const fetchSpotifyData = async () => {
            setLoading(true);
            try {
              const [topTracks, topArtists, recentTracks] = await Promise.all([
                fetch(`https://api.spotify.com/v1/me/top/tracks?time_range=${timeRange}&limit=50`, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                }).then(r => r.json()),
                fetch(`https://api.spotify.com/v1/me/top/artists?time_range=${timeRange}&limit=50`, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                }).then(r => r.json()),
                fetch(`https://api.spotify.com/v1/me/player/recently-played?limit=50`, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                }).then(r => r.json())
              ]);

              const totalListeningTime = topTracks.items?.reduce((acc, track) => acc + track.duration_ms, 0) || 0;
              
              const genreCounts = {};
              topArtists.items?.forEach(artist => {
                artist.genres.forEach(genre => {
                  genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                });
              });
              
              const topGenres = Object.entries(genreCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([genre, count]) => ({ genre, count }));

              setStats({
                topTracks: topTracks.items || [],
                topArtists: topArtists.items || [],
                recentTracks: recentTracks.items || [],
                totalListeningTime,
                topGenres
              });
            } catch (error) {
              console.error('Error fetching Spotify data:', error);
              if (error.message?.includes('401')) {
                setIsAuthenticated(false);
                setAccessToken('');
              }
            }
            setLoading(false);
          };

          const formatDuration = (ms) => {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            return `${hours}h ${minutes}m`;
          };

          const formatTime = (ms) => {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
          };

          const timeRanges = [
            { value: 'short_term', label: 'Last 4 Weeks' },
            { value: 'medium_term', label: 'Last 6 Months' },
            { value: 'long_term', label: 'All Time' }
          ];

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-400 via-blue-500 to-purple-600 flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
                  <div className="bg-green-500 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                  </div>
                  <h1 className="text-4xl font-bold text-gray-800 mb-4">Spotify Stats</h1>
                  <p className="text-gray-600 mb-8">
                    Get detailed insights into your listening habits, top tracks, artists, and more.
                  </p>
                  <button
                    onClick={handleLogin}
                    className="bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-8 rounded-full text-lg transition-all transform hover:scale-105 shadow-lg"
                  >
                    Connect with Spotify
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              <div className="bg-gradient-to-r from-green-400 to-blue-500 text-white p-8 shadow-lg">
                <div className="max-w-7xl mx-auto">
                  <div className="flex items-center justify-between mb-6">
                    <h1 className="text-4xl font-bold flex items-center gap-3">
                      <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                      </svg>
                      Your Spotify Stats
                    </h1>
                  </div>
                  
                  <div className="flex gap-2 flex-wrap">
                    {timeRanges.map(range => (
                      <button
                        key={range.value}
                        onClick={() => setTimeRange(range.value)}
                        className={`px-6 py-2 rounded-full font-medium transition-all ${
                          timeRange === range.value
                            ? 'bg-white text-blue-500 shadow-lg'
                            : 'bg-white/20 hover:bg-white/30'
                        }`}
                      >
                        {range.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {loading ? (
                <div className="flex items-center justify-center h-64">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                </div>
              ) : stats ? (
                <div className="max-w-7xl mx-auto p-8">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div className="bg-white rounded-2xl p-6 shadow-lg">
                      <div className="flex items-center gap-3 mb-2">
                        <svg className="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 className="text-lg font-semibold text-gray-700">Listening Time</h3>
                      </div>
                      <p className="text-3xl font-bold text-gray-800">{formatDuration(stats.totalListeningTime)}</p>
                    </div>
                    
                    <div className="bg-white rounded-2xl p-6 shadow-lg">
                      <div className="flex items-center gap-3 mb-2">
                        <svg className="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <h3 className="text-lg font-semibold text-gray-700">Top Tracks</h3>
                      </div>
                      <p className="text-3xl font-bold text-gray-800">{stats.topTracks.length}</p>
                    </div>
                    
                    <div className="bg-white rounded-2xl p-6 shadow-lg">
                      <div className="flex items-center gap-3 mb-2">
                        <svg className="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <h3 className="text-lg font-semibold text-gray-700">Top Artists</h3>
                      </div>
                      <p className="text-3xl font-bold text-gray-800">{stats.topArtists.length}</p>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div className="bg-white rounded-2xl p-6 shadow-lg">
                      <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg className="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                        Top Tracks
                      </h2>
                      <div className="space-y-3">
                        {stats.topTracks.slice(0, 10).map((track, index) => (
                          <div key={track.id} className="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 transition-colors">
                            <div className="text-2xl font-bold text-gray-400 w-8">{index + 1}</div>
                            {track.album.images[0] && (
                              <img src={track.album.images[0].url} alt={track.name} className="w-12 h-12 rounded-lg shadow" />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-800 truncate">{track.name}</p>
                              <p className="text-sm text-gray-500 truncate">{track.artists.map(a => a.name).join(', ')}</p>
                            </div>
                            <span className="text-sm text-gray-500">{formatTime(track.duration_ms)}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="bg-white rounded-2xl p-6 shadow-lg">
                      <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg className="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        Top Artists
                      </h2>
                      <div className="space-y-3">
                        {stats.topArtists.slice(0, 10).map((artist, index) => (
                          <div key={artist.id} className="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 transition-colors">
                            <div className="text-2xl font-bold text-gray-400 w-8">{index + 1}</div>
                            {artist.images[0] && (
                              <img src={artist.images[0].url} alt={artist.name} className="w-12 h-12 rounded-full shadow" />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-800 truncate">{artist.name}</p>
                              <p className="text-sm text-gray-500 truncate">{artist.genres.slice(0, 2).join(', ')}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl p-6 shadow-lg">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <svg className="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                      Top Genres
                    </h2>
                    <div className="space-y-3">
                      {stats.topGenres.map((genre, index) => (
                        <div key={genre.genre} className="flex items-center gap-4">
                          <div className="text-xl font-bold text-gray-400 w-8">{index + 1}</div>
                          <div className="flex-1">
                            <div className="flex justify-between mb-1">
                              <span className="font-medium text-gray-800 capitalize">{genre.genre}</span>
                              <span className="text-sm text-gray-500">{genre.count} artists</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div
                                className="bg-gradient-to-r from-purple-400 to-pink-500 h-2 rounded-full transition-all"
                                style={{ width: `${(genre.count / stats.topGenres[0].count) * 100}%` }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              ) : null}
            </div>
          );
        };

        ReactDOM.render(<SpotifyStats />, document.getElementById('root'));
    </script>
</body>
</html>
