<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Stats Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background: #0a0a0a; margin: 0; }
      .gradient-red { background: linear-gradient(135deg, #1a0000 0%, #0a0a0a 50%, #1a0000 100%); }
      .card-dark { background: rgba(26, 0, 0, 0.3); border: 1px solid rgba(220, 38, 38, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const SpotifyStats = () => {
          const [token, setToken] = useState('');
          const [authed, setAuthed] = useState(false);
          const [range, setRange] = useState('medium_term');
          const [data, setData] = useState(null);
          const [loading, setLoading] = useState(false);
          const [tab, setTab] = useState('tracks');
          const [search, setSearch] = useState('');
          const [results, setResults] = useState([]);
          const [detail, setDetail] = useState(null);

          const CID = '28a38a04492140ab9d521d62eed5f9d8';
          const REDIR = 'https://giatopcst2-code.github.io/new/';

          const genStr = (len) => {
            const p = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const v = crypto.getRandomValues(new Uint8Array(len));
            return v.reduce((acc, x) => acc + p[x % p.length], "");
          };

          const sha = async (plain) => {
            const enc = new TextEncoder();
            const d = enc.encode(plain);
            return window.crypto.subtle.digest('SHA-256', d);
          };

          const b64 = (input) => {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
              .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
          };

          useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
              const ver = localStorage.getItem('code_verifier');
              if (ver) {
                exchange(code, ver);
              }
            }
          }, []);

          useEffect(() => {
            if (authed && token) {
              load();
            }
          }, [authed, token]);

          useEffect(() => {
            if (authed && token && data) {
              load();
            }
          }, [range]);

          const exchange = async (code, ver) => {
            try {
              const res = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                  client_id: CID,
                  grant_type: 'authorization_code',
                  code: code,
                  redirect_uri: REDIR,
                  code_verifier: ver,
                }),
              });
              const json = await res.json();
              
              if (json.access_token) {
                setToken(json.access_token);
                setAuthed(true);
                localStorage.removeItem('code_verifier');
                window.history.replaceState({}, document.title, window.location.pathname);
              }
            } catch (e) {
              console.error('Exchange error:', e);
            }
          };

          const login = async () => {
            const ver = genStr(64);
            const hashed = await sha(ver);
            const challenge = b64(hashed);
            localStorage.setItem('code_verifier', ver);

            const scope = 'user-top-read user-read-recently-played user-library-read user-read-currently-playing user-read-playback-state';
            const url = new URL("https://accounts.spotify.com/authorize");
            url.search = new URLSearchParams({
              response_type: 'code',
              client_id: CID,
              scope,
              code_challenge_method: 'S256',
              code_challenge: challenge,
              redirect_uri: REDIR,
            }).toString();
            window.location.href = url.toString();
          };

          const load = async () => {
            setLoading(true);
            try {
              const h = { Authorization: `Bearer ${token}` };
              
              const res1 = await fetch(`https://api.spotify.com/v1/me/top/tracks?time_range=${range}&limit=50`, { headers: h });
              const res2 = await fetch(`https://api.spotify.com/v1/me/top/artists?time_range=${range}&limit=50`, { headers: h });
              const res3 = await fetch(`https://api.spotify.com/v1/me/player/recently-played?limit=50`, { headers: h });

              const tracks = await res1.json();
              const artists = await res2.json();
              const recent = await res3.json();

              const tpc = {};
              const apc = {};
              const alb = {};

              tracks.items?.forEach((t, i) => {
                const pc = 50 - i;
                tpc[t.id] = pc;
                
                t.artists.forEach(a => {
                  apc[a.id] = (apc[a.id] || 0) + pc;
                });

                const k = t.album.id;
                if (!alb[k]) {
                  alb[k] = { album: t.album, playCount: 0, tracks: [] };
                }
                alb[k].playCount += pc;
                alb[k].tracks.push(t);
              });

              const albums = Object.values(alb).sort((a, b) => b.playCount - a.playCount).slice(0, 50);
              const time = tracks.items?.reduce((acc, t) => acc + (t.duration_ms * (tpc[t.id] || 1)), 0) || 0;
              
              const gc = {};
              artists.items?.forEach(a => {
                a.genres.forEach(g => {
                  gc[g] = (gc[g] || 0) + 1;
                });
              });
              
              const genres = Object.entries(gc).sort((a, b) => b[1] - a[1]).slice(0, 20).map(([genre, count]) => ({ genre, count }));

              setData({
                tracks: tracks.items?.map(t => ({ ...t, playCount: tpc[t.id] || 0 })) || [],
                artists: artists.items?.map(a => ({ ...a, playCount: apc[a.id] || 0 })) || [],
                albums,
                recent: recent.items || [],
                time,
                genres,
                tpc,
                apc
              });
            } catch (e) {
              console.error('Load error:', e);
            }
            setLoading(false);
          };

          const fetchCurrentlyPlaying = async () => {
            try {
              const h = { Authorization: `Bearer ${token}` };
              const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', { headers: h });
              
              if (res.status === 204 || !res.ok) {
                setCurrentlyPlaying(null);
                return;
              }
              
              const data = await res.json();
              
              if (data && data.item) {
                setCurrentlyPlaying({
                  track: data.item,
                  isPlaying: data.is_playing,
                  progress: data.progress_ms
                });
              } else {
                setCurrentlyPlaying(null);
              }
            } catch (e) {
              console.error('Currently playing error:', e);
              setCurrentlyPlaying(null);
            }
          };

          const doSearch = async () => {
            if (!search.trim()) return;
            try {
              const h = { Authorization: `Bearer ${token}` };
              const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(search)}&type=track&limit=20`, { headers: h });
              const json = await res.json();
              setResults(json.tracks?.items || []);
            } catch (e) {
              console.error('Search error:', e);
            }
          };

          const showDetail = async (track) => {
            setDetail(null);
            try {
              const h = { Authorization: `Bearer ${token}` };
              
              const res1 = await fetch(`https://api.spotify.com/v1/me/player/recently-played?limit=50`, { headers: h });
              const res2 = await fetch(`https://api.spotify.com/v1/audio-features/${track.id}`, { headers: h });

              const rec = await res1.json();
              const aud = await res2.json();

              const hist = rec.items?.filter(i => i.track.id === track.id) || [];
              
              let first = null;
              let last = null;
              
              if (hist.length > 0) {
                const dates = hist.map(i => new Date(i.played_at));
                first = new Date(Math.min(...dates));
                last = new Date(Math.max(...dates));
              }

              setDetail({
                ...track,
                first,
                last,
                plays: data?.tpc?.[track.id] || hist.length,
                audio: aud,
                hist
              });
            } catch (e) {
              console.error('Detail error:', e);
            }
          };

          const fmtDur = (ms) => {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
          };

          const fmtTime = (ms) => {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${m}:${s.toString().padStart(2, '0')}`;
          };

          const fmtDate = (d) => {
            if (!d) return 'Unknown';
            return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
          };

          const ranges = [
            { value: 'short_term', label: '1 Week' },
            { value: 'medium_term', label: '1 Month' },
            { value: 'long_term', label: 'All Time' }
          ];

          if (!authed) {
            return (
              <div className="min-h-screen gradient-red flex items-center justify-center p-4">
                <div className="card-dark rounded-3xl shadow-2xl p-12 max-w-md w-full text-center backdrop-blur-sm">
                  <div className="bg-gradient-to-br from-red-600 to-red-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                  </div>
                  <h1 className="text-5xl font-bold text-white mb-4">Spotify Stats Pro</h1>
                  <p className="text-gray-400 mb-8 text-lg">Get comprehensive insights into your listening habits</p>
                  <button onClick={login} className="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-semibold py-4 px-10 rounded-full text-lg transition-all transform hover:scale-105 shadow-lg">
                    Connect with Spotify
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen gradient-red">
              <div className="bg-gradient-to-r from-red-900 to-black text-white p-8 shadow-2xl border-b border-red-800">
                <div className="max-w-7xl mx-auto">
                  <h1 className="text-5xl font-bold mb-6">Your Spotify Stats Pro</h1>
                  
                  <div className="flex gap-3 flex-wrap mb-6">
                    {ranges.map(r => (
                      <button key={r.label} onClick={() => setRange(r.value)} className={`px-6 py-3 rounded-full font-medium transition-all ${range === r.value ? 'bg-red-600 shadow-lg scale-105' : 'bg-red-900/30 hover:bg-red-900/50 border border-red-800'}`}>
                        {r.label}
                      </button>
                    ))}
                  </div>

                  <div className="flex gap-3 mb-6">
                    <input type="text" placeholder="Search for any track..." value={search} onChange={(e) => setSearch(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && doSearch()} className="flex-1 px-6 py-3 rounded-full bg-black/50 border border-red-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-600" />
                    <button onClick={doSearch} className="px-8 py-3 bg-red-600 hover:bg-red-700 rounded-full font-semibold">Search</button>
                  </div>
                </div>
              </div>

              {loading ? (
                <div className="flex items-center justify-center h-64">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-red-600"></div>
                </div>
              ) : (
                <>
                  {results.length > 0 && (
                    <div className="max-w-7xl mx-auto p-8">
                      <div className="card-dark rounded-2xl p-6 backdrop-blur-sm mb-8">
                        <h2 className="text-3xl font-bold text-white mb-6">Search Results</h2>
                        <div className="space-y-3">
                          {results.map((t) => (
                            <div key={t.id} onClick={() => showDetail(t)} className="flex items-center gap-4 p-4 rounded-xl hover:bg-red-900/20 transition cursor-pointer">
                              <img src={t.album.images[0]?.url} alt={t.name} className="w-16 h-16 rounded-lg" />
                              <div className="flex-1">
                                <p className="font-semibold text-white text-lg">{t.name}</p>
                                <p className="text-gray-400">{t.artists.map(a => a.name).join(', ')}</p>
                              </div>
                              <span className="text-gray-500">{fmtTime(t.duration_ms)}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {detail && (
                    <div className="max-w-7xl mx-auto p-8">
                      <div className="card-dark rounded-2xl p-8 backdrop-blur-sm mb-8">
                        <button onClick={() => setDetail(null)} className="text-red-500 hover:text-red-400 mb-4">‚Üê Back</button>
                        <div className="flex gap-8 flex-col md:flex-row">
                          <img src={detail.album.images[0]?.url} alt={detail.name} className="w-64 h-64 rounded-2xl shadow-2xl mx-auto md:mx-0" />
                          <div className="flex-1">
                            <h2 className="text-4xl font-bold text-white mb-2">{detail.name}</h2>
                            <p className="text-2xl text-gray-400 mb-6">{detail.artists.map(a => a.name).join(', ')}</p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div className="bg-red-900/20 rounded-xl p-4 border border-red-800">
                                <p className="text-gray-400 text-sm mb-1">Total Plays</p>
                                <p className="text-3xl font-bold text-white">{detail.plays}</p>
                              </div>
                              <div className="bg-red-900/20 rounded-xl p-4 border border-red-800">
                                <p className="text-gray-400 text-sm mb-1">Duration</p>
                                <p className="text-3xl font-bold text-white">{fmtTime(detail.duration_ms)}</p>
                              </div>
                              <div className="bg-red-900/20 rounded-xl p-4 border border-red-800">
                                <p className="text-gray-400 text-sm mb-1">First Played</p>
                                <p className="text-lg font-semibold text-white">{fmtDate(detail.first)}</p>
                              </div>
                              <div className="bg-red-900/20 rounded-xl p-4 border border-red-800">
                                <p className="text-gray-400 text-sm mb-1">Last Played</p>
                                <p className="text-lg font-semibold text-white">{fmtDate(detail.last)}</p>
                              </div>
                            </div>

                            {detail.audio && (
                              <div className="mt-6 bg-red-900/20 rounded-xl p-4 border border-red-800">
                                <p className="text-gray-400 text-sm mb-3">Audio Features</p>
                                <div className="grid grid-cols-3 gap-4 text-center">
                                  <div>
                                    <p className="text-gray-400 text-xs">Energy</p>
                                    <p className="text-xl font-bold text-white">{Math.round(detail.audio.energy * 100)}%</p>
                                  </div>
                                  <div>
                                    <p className="text-gray-400 text-xs">Danceability</p>
                                    <p className="text-xl font-bold text-white">{Math.round(detail.audio.danceability * 100)}%</p>
                                  </div>
                                  <div>
                                    <p className="text-gray-400 text-xs">Tempo</p>
                                    <p className="text-xl font-bold text-white">{Math.round(detail.audio.tempo)} BPM</p>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {data && !detail && (
                    <div className="max-w-7xl mx-auto p-8">
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <p className="text-gray-400 text-sm mb-2">Listening Time</p>
                          <p className="text-4xl font-bold text-white">{fmtDur(data.time)}</p>
                        </div>
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <p className="text-gray-400 text-sm mb-2">Tracks</p>
                          <p className="text-4xl font-bold text-white">{data.tracks.length}</p>
                        </div>
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <p className="text-gray-400 text-sm mb-2">Artists</p>
                          <p className="text-4xl font-bold text-white">{data.artists.length}</p>
                        </div>
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <p className="text-gray-400 text-sm mb-2">Albums</p>
                          <p className="text-4xl font-bold text-white">{data.albums.length}</p>
                        </div>
                      </div>

                      <div className="flex gap-4 mb-6 flex-wrap">
                        {['tracks', 'artists', 'albums', 'genres'].map(t => (
                          <button key={t} onClick={() => setTab(t)} className={`px-8 py-3 rounded-full font-semibold ${tab === t ? 'bg-red-600 text-white' : 'bg-red-900/30 text-gray-400 hover:bg-red-900/50 border border-red-800'}`}>
                            {t.charAt(0).toUpperCase() + t.slice(1)}
                          </button>
                        ))}
                      </div>

                      {tab === 'tracks' && (
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <h2 className="text-3xl font-bold text-white mb-6">Top Tracks</h2>
                          <div className="space-y-3">
                            {data.tracks.map((t, i) => (
                              <div key={t.id} onClick={() => showDetail(t)} className="flex items-center gap-4 p-4 rounded-xl hover:bg-red-900/20 transition cursor-pointer">
                                <div className="text-3xl font-bold text-red-600 w-12">{i + 1}</div>
                                <img src={t.album.images[0]?.url} alt={t.name} className="w-16 h-16 rounded-lg" />
                                <div className="flex-1 min-w-0">
                                  <p className="font-semibold text-white text-lg truncate">{t.name}</p>
                                  <p className="text-gray-400 truncate">{t.artists.map(a => a.name).join(', ')}</p>
                                </div>
                                <div className="text-right">
                                  <p className="text-red-500 font-bold text-lg">{t.playCount} plays</p>
                                  <p className="text-gray-500 text-sm">{fmtTime(t.duration_ms)}</p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {tab === 'artists' && (
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <h2 className="text-3xl font-bold text-white mb-6">Top Artists</h2>
                          <div className="space-y-3">
                            {data.artists.map((a, i) => (
                              <div key={a.id} className="flex items-center gap-4 p-4 rounded-xl hover:bg-red-900/20 transition">
                                <div className="text-3xl font-bold text-red-600 w-12">{i + 1}</div>
                                <img src={a.images[0]?.url} alt={a.name} className="w-16 h-16 rounded-full" />
                                <div className="flex-1 min-w-0">
                                  <p className="font-semibold text-white text-lg truncate">{a.name}</p>
                                  <p className="text-gray-400 truncate">{a.genres.slice(0, 3).join(', ')}</p>
                                </div>
                                <p className="text-red-500 font-bold text-lg">{a.playCount} plays</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {tab === 'albums' && (
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <h2 className="text-3xl font-bold text-white mb-6">Top Albums</h2>
                          <div className="space-y-3">
                            {data.albums.map((item, i) => (
                              <div key={item.album.id} className="flex items-center gap-4 p-4 rounded-xl hover:bg-red-900/20 transition">
                                <div className="text-3xl font-bold text-red-600 w-12">{i + 1}</div>
                                <img src={item.album.images[0]?.url} alt={item.album.name} className="w-16 h-16 rounded-lg" />
                                <div className="flex-1 min-w-0">
                                  <p className="font-semibold text-white text-lg truncate">{item.album.name}</p>
                                  <p className="text-gray-400 truncate">{item.album.artists.map(a => a.name).join(', ')}</p>
                                </div>
                                <div className="text-right">
                                  <p className="text-red-500 font-bold text-lg">{item.playCount} plays</p>
                                  <p className="text-gray-500 text-sm">{item.tracks.length} tracks</p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {tab === 'genres' && (
                        <div className="card-dark rounded-2xl p-6 backdrop-blur-sm">
                          <h2 className="text-3xl font-bold text-white mb-6">Top Genres</h2>
                          <div className="space-y-4">
                            {data.genres.map((g, i) => (
                              <div key={g.genre} className="flex items-center gap-4">
                                <div className="text-2xl font-bold text-red-600 w-12">{i + 1}</div>
                                <div className="flex-1">
                                  <div className="flex justify-between mb-2">
                                    <span className="font-semibold text-white text-lg capitalize">{g.genre}</span>
                                    <span className="text-gray-400">{g.count} artists</span>
                                  </div>
                                  <div className="w-full bg-black/50 rounded-full h-3">
                                    <div className="bg-gradient-to-r from-red-600 to-red-800 h-3 rounded-full" style={{ width: `${(g.count / data.genres[0].count) * 100}%` }}></div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </>
              )}
            </div>
          );
        };

        ReactDOM.render(<SpotifyStats />, document.getElementById('root'));
    </script>
</body>
</html>
